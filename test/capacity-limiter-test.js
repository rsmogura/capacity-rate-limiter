"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
require("mocha");
const chai_1 = require("chai");
const util = require("util");
const capacity_limiter_1 = require("../lib/capacity-limiter");
const setTimeoutPromise = util.promisify(setTimeout);
describe('Capacity Limiter', () => {
    it('Capacity operations', () => {
        const limiter = new capacity_limiter_1.CapacityLimiter({
            maximumCapacity: 200,
            minimumCapacity: -10
        });
        limiter.consumeCapacity(-10);
        chai_1.assert.equal(limiter.getConsumedCapacity(), -10);
        limiter.consumeCapacity(10);
        chai_1.assert.equal(limiter.getConsumedCapacity(), 0);
        limiter.consumeCapacity(-100);
        chai_1.assert.equal(limiter.getConsumedCapacity(), -10);
    });
    it('Listeners wait for capacity', done => {
        const limiter = new capacity_limiter_1.CapacityLimiter({
            maximumCapacity: 200
        });
        let waitResolved = false;
        const wait = limiter.consumeCapacity(100)
            .then(() => limiter.consumeCapacity(150))
            .then(() => waitResolved = true);
        setTimeoutPromise(10) // Wait a little bit to check if promise didn't get resolved
            .then(() => {
            chai_1.assert.isFalse(waitResolved);
            chai_1.assert.equal(limiter.getConsumedCapacity(), 100);
            limiter.consumeCapacity(-70);
            return wait.then(() => {
                chai_1.assert.equal(limiter.getConsumedCapacity(), 180); // 100 + 150 (wait) - 70
                done();
            });
        })
            .catch(done);
    });
    it('Only one listeners gets invoked', done => {
        const limiter = new capacity_limiter_1.CapacityLimiter({
            maximumCapacity: 200
        });
        let resolvedPromises = 0;
        limiter.consumeCapacity(100);
        Promise.all([
            limiter.consumeCapacity(150).then(() => { resolvedPromises++; chai_1.assert.equal(resolvedPromises, 1); }),
            limiter.consumeCapacity(160).then(() => { resolvedPromises++; chai_1.assert.equal(resolvedPromises, 1); }),
            limiter.consumeCapacity(170).then(() => { resolvedPromises++; chai_1.assert.equal(resolvedPromises, 1); })
        ])
            .then(() => done('Should not all be resolved'))
            .catch(err => done(err));
        limiter.consumeCapacity(-100);
        setTimeoutPromise(10) // Wait a little bit to check if promise didn't get resolved
            .then(() => chai_1.assert.equal(resolvedPromises, 1))
            .then(() => done())
            .catch(done);
    });
    it('Changing maximum capacity notifies listeners', done => {
        const limiter = new capacity_limiter_1.CapacityLimiter({
            maximumCapacity: 200
        });
        let waitResolved = false;
        const wait = limiter.consumeCapacity(100)
            .then(() => limiter.consumeCapacity(150))
            .then(() => waitResolved = true);
        setTimeoutPromise(10) // Wait a little bit to check if promise didn't get resolved
            .then(() => {
            chai_1.assert.isFalse(waitResolved);
            chai_1.assert.equal(limiter.getConsumedCapacity(), 100);
            limiter.setMaximumCapacity(250);
            return wait.then(() => {
                chai_1.assert.equal(limiter.getConsumedCapacity(), 250);
                done();
            });
        })
            .catch(done);
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FwYWNpdHktbGltaXRlci10ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiY2FwYWNpdHktbGltaXRlci10ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsaUJBQWU7QUFFZiwrQkFBOEI7QUFDOUIsNkJBQTZCO0FBRTdCLDhEQUEwRDtBQUUxRCxNQUFNLGlCQUFpQixHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsVUFBVSxDQUFDLENBQUM7QUFFckQsUUFBUSxDQUFDLGtCQUFrQixFQUFFLEdBQUcsRUFBRTtJQUNoQyxFQUFFLENBQUMscUJBQXFCLEVBQUUsR0FBRyxFQUFFO1FBQzdCLE1BQU0sT0FBTyxHQUFHLElBQUksa0NBQWUsQ0FBQztZQUNsQyxlQUFlLEVBQUUsR0FBRztZQUNwQixlQUFlLEVBQUUsQ0FBQyxFQUFFO1NBQ3JCLENBQUMsQ0FBQztRQUVILE9BQU8sQ0FBQyxlQUFlLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUM3QixhQUFNLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxtQkFBbUIsRUFBRSxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUM7UUFFakQsT0FBTyxDQUFDLGVBQWUsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUM1QixhQUFNLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxtQkFBbUIsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBRS9DLE9BQU8sQ0FBQyxlQUFlLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUM5QixhQUFNLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxtQkFBbUIsRUFBRSxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDbkQsQ0FBQyxDQUFDLENBQUM7SUFFSCxFQUFFLENBQUMsNkJBQTZCLEVBQUUsSUFBSSxDQUFDLEVBQUU7UUFDdkMsTUFBTSxPQUFPLEdBQUcsSUFBSSxrQ0FBZSxDQUFDO1lBQ2xDLGVBQWUsRUFBRSxHQUFHO1NBQ3JCLENBQUMsQ0FBQztRQUVILElB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LEdBQUc7U0FDckIsQ0FBQyxDQUFDO1FBRUgsSUFBSSxZQUFZLEdBQUcsS0FBSyxDQUFDO1FBQ3pCLE1BQU0sSUFBSSxHQUFHLE9BQU8sQ0FBQyxlQUFlLENBQUMsR0FBRyxDQUFDO2FBQ3RDLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQyxPQUFPLENBQUMsZUFBZSxDQUFDLEdBQUcsQ0FBQyxDQUFDO2FBQ3hDLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDLENBQUM7UUFFbkMsaUJBQWlCLENBQUMsRUFBRSxDQUFDLENBQUMsNERBQTREO2FBQy9FLElBQUksQ0FBQyxHQUFHLEVBQUU7WUFDVCxhQUFNLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQyxDQUFBO1lBQzVCLGFBQU0sQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLG1CQUFtQixFQUFFLEVBQUUsR0FBRyxDQUFDLENBQUM7WUFFakQsT0FBTyxDQUFDLGtCQUFrQixDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBRWhDLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUU7Z0JBQ3BCLGFBQU0sQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLG1CQUFtQixFQUFFLEVBQUUsR0FBRyxDQUFDLENBQUM7Z0JBQ2pELElBQUksRUFBRSxDQUFDO1lBQ1QsQ0FBQyxDQUFDLENBQUE7UUFDSixDQUFDLENBQUM7YUFDRCxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUE7SUFDaEIsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAnbW9jaGEnO1xuXG5pbXBvcnQgeyBhc3NlcnQgfSBmcm9tICdjaGFpJztcbmltcG9ydCAqIGFzIHV0aWwgZnJvbSAndXRpbCc7XG5cbmltcG9ydCB7IENhcGFjaXR5TGltaXRlciB9IGZyb20gJy4uL2xpYi9jYXBhY2l0eS1saW1pdGVyJztcblxuY29uc3Qgc2V0VGltZW91dFByb21pc2UgPSB1dGlsLnByb21pc2lmeShzZXRUaW1lb3V0KTtcblxuZGVzY3JpYmUoJ0NhcGFjaXR5IExpbWl0ZXInLCAoKSA9PiB7XG4gIGl0KCdDYXBhY2l0eSBvcGVyYXRpb25zJywgKCkgPT4ge1xuICAgIGNvbnN0IGxpbWl0ZXIgPSBuZXcgQ2FwYWNpdHlMaW1pdGVyKHtcbiAgICAgIG1heGltdW1DYXBhY2l0eTogMjAwLFxuICAgICAgbWluaW11bUNhcGFjaXR5OiAtMTBcbiAgICB9KTtcblxuICAgIGxpbWl0ZXIuY29uc3VtZUNhcGFjaXR5KC0xMCk7XG4gICAgYXNzZXJ0LmVxdWFsKGxpbWl0ZXIuZ2V0Q29uc3VtZWRDYXBhY2l0eSgpLCAtMTApO1xuXG4gICAgbGltaXRlci5jb25zdW1lQ2FwYWNpdHkoMTApO1xuICAgIGFzc2VydC5lcXVhbChsaW1pdGVyLmdldENvbnN1bWVkQ2FwYWNpdHkoKSwgMCk7XG5cbiAgICBsaW1pdGVyLmNvbnN1bWVDYXBhY2l0eSgtMTAwKTtcbiAgICBhc3NlcnQuZXF1YWwobGltaXRlci5nZXRDb25zdW1lZENhcGFjaXR5KCksIC0xMCk7XG4gIH0pO1xuXG4gIGl0KCdMaXN0ZW5lcnMgd2FpdCBmb3IgY2FwYWNpdHknLCBkb25lID0+IHtcbiAgICBjb25zdCBsaW1pdGVyID0gbmV3IENhcGFjaXR5TGltaXRlcih7XG4gICAgICBtYXhpbXVtQ2FwYWNpdHk6IDIwMFxuICAgIH0pO1xuXG4gICAgbGV0IHdhaXRSZXNvbHZlZCA9IGZhbHNlO1xuICAgIGNvbnN0IHdhaXQgPSBsaW1pdGVyLmNvbnN1bWVDYXBhY2l0eSgxMDApXG4gICAgICAudGhlbigoKSA9PiBsaW1pdGVyLmNvbnN1bWVDYXBhY2l0eSgxNTApKVxuICAgICAgLnRoZW4oKCkgPT4gd2FpdFJlc29sdmVkID0gdHJ1ZSk7XG5cbiAgICBzZXRUaW1lb3V0UHJvbWlzZSgxMCkgLy8gV2FpdCBhIGxpdHRsZSBiaXQgdG8gY2hlY2sgaWYgcHJvbWlzZSBkaWRuJ3QgZ2V0IHJlc29sdmVkXG4gICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgIGFzc2VydC5pc0ZhbHNlKHdhaXRSZXNvbHZlZClcbiAgICAgICAgYXNzZXJ0LmVxdWFsKGxpbWl0ZXIuZ2V0Q29uc3VtZWRDYXBhY2l0eSgpLCAxMDApO1xuXG4gICAgICAgIGxpbWl0ZXIuY29uc3VtZUNhcGFjaXR5KC03MCk7XG5cbiAgICAgICAgcmV0dXJuIHdhaXQudGhlbigoKSA9PiB7XG4gICAgICAgICAgYXNzZXJ0LmVxdWFsKGxpbWl0ZXIuZ2V0Q29uc3VtZWRDYXBhY2l0eSgpLCAxODApOyAvLyAxMDAgKyAxNTAgKHdhaXQpIC0gNzBcbiAgICAgICAgICBkb25lKCk7XG4gICAgICAgIH0pXG4gICAgICB9KVxuICAgICAgLmNhdGNoKGRvbmUpXG4gIH0pO1xuXG4gIGl0KCdPbmx5IG9uZSBsaXN0ZW5lcnMgZ2V0cyBpbnZva2VkJywgZG9uZSA9PiB7XG4gICAgY29uc3QgbGltaXRlciA9IG5ldyBDYXBhY2l0eUxpbWl0ZXIoe1xuICAgICAgbWF4aW11bUNhcGFjaXR5OiAyMDBcbiAgICB9KTtcblxuICAgIGxldCByZXNvbHZlZFByb21pc2VzID0gMDtcbiAgICBsaW1pdGVyLmNvbnN1bWVDYXBhY2l0eSgxMDApO1xuXG4gICAgUHJvbWlzZS5hbGwoW1xuICAgICAgbGltaXRlci5jb25zdW1lQ2FwYWNpdHkoMTUwKS50aGVuKCgpID0+IHtyZXNvbHZlZFByb21pc2VzKys7IGFzc2VydC5lcXVhbChyZXNvbHZlZFByb21pc2VzLCAxKX0pLFxuICAgICAgbGltaXRlci5jb25zdW1lQ2FwYWNpdHkoMTYwKS50aGVuKCgpID0+IHtyZXNvbHZlZFByb21pc2VzKys7IGFzc2VydC5lcXVhbChyZXNvbHZlZFByb21pc2VzLCAxKX0pLFxuICAgICAgbGltaXRlci5jb25zdW1lQ2FwYWNpdHkoMTcwKS50aGVuKCgpID0+IHtyZXNvbHZlZFByb21pc2VzKys7IGFzc2VydC5lcXVhbChyZXNvbHZlZFByb21pc2VzLCAxKX0pXG4gICAgXSlcbiAgICAudGhlbigoKSA9PiBkb25lKCdTaG91bGQgbm90IGFsbCBiZSByZXNvbHZlZCcpKVxuICAgIC5jYXRjaChlcnIgPT4gZG9uZShlcnIpKTtcblxuICAgIGxpbWl0ZXIuY29uc3VtZUNhcGFjaXR5KC0xMDApO1xuICAgIFxuICAgIHNldFRpbWVvdXRQcm9taXNlKDEwKSAvLyBXYWl0IGEgbGl0dGxlIGJpdCB0byBjaGVjayBpZiBwcm9taXNlIGRpZG4ndCBnZXQgcmVzb2x2ZWRcbiAgICAgIC50aGVuKCgpID0+IGFzc2VydC5lcXVhbChyZXNvbHZlZFByb21pc2VzLCAxKSlcbiAgICAgIC50aGVuKCgpID0+IGRvbmUoKSlcbiAgICAgIC5jYXRjaChkb25lKVxuICB9KTtcblxuICBpdCgnQ2hhbmdpbmcgbWF4aW11bSBjYXBhY2l0eSBub3RpZmllcyBsaXN0ZW5lcnMnLCBkb25lID0+IHtcbiAgICBjb25zdCBsaW1pdGVyID0gbmV3IENhcGFjaXR5TGltaXRlcih7XG4gICAgICBtYXhpbXVtQ2FwYWNpdHk6IDIwMFxuICAgIH0pO1xuXG4gICAgbGV0IHdhaXRSZXNvbHZlZCA9IGZhbHNlO1xuICAgIGNvbnN0IHdhaXQgPSBsaW1pdGVyLmNvbnN1bWVDYXBhY2l0eSgxMDApXG4gICAgICAudGhlbigoKSA9PiBsaW1pdGVyLmNvbnN1bWVDYXBhY2l0eSgxNTApKVxuICAgICAgLnRoZW4oKCkgPT4gd2FpdFJlc29sdmVkID0gdHJ1ZSk7XG5cbiAgICBzZXRUaW1lb3V0UHJvbWlzZSgxMCkgLy8gV2FpdCBhIGxpdHRsZSBiaXQgdG8gY2hlY2sgaWYgcHJvbWlzZSBkaWRuJ3QgZ2V0IHJlc29sdmVkXG4gICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgIGFzc2VydC5pc0ZhbHNlKHdhaXRSZXNvbHZlZClcbiAgICAgICAgYXNzZXJ0LmVxdWFsKGxpbWl0ZXIuZ2V0Q29uc3VtZWRDYXBhY2l0eSgpLCAxMDApO1xuXG4gICAgICAgIGxpbWl0ZXIuc2V0TWF4aW11bUNhcGFjaXR5KDI1MCk7XG5cbiAgICAgICAgcmV0dXJuIHdhaXQudGhlbigoKSA9PiB7XG4gICAgICAgICAgYXNzZXJ0LmVxdWFsKGxpbWl0ZXIuZ2V0Q29uc3VtZWRDYXBhY2l0eSgpLCAyNTApO1xuICAgICAgICAgIGRvbmUoKTtcbiAgICAgICAgfSlcbiAgICAgIH0pXG4gICAgICAuY2F0Y2goZG9uZSlcbiAgfSk7XG59KSJdfQ==